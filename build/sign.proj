<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" DefaultTargets="Test" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), 'README.md'))\build\common.props" />
  <Import Project="$(SolutionPackagesFolder)microbuild.core.0.2.0\build\MicroBuild.Core.props"/>
  
  <!-- Configuration/global properties -->
  <PropertyGroup>
    <CommonMSBuildProperties>
      Configuration=$(Configuration);
      ReleaseLabel=$(ReleaseLabel);
      BuildNumber=$(BuildNumber);
      BuildRTM=$(BuildRTM);
    </CommonMSBuildProperties>
    <OutDir>$(ArtifactsDirectory)</OutDir>
    <IntermediateOutputPath>$(ArtifactsDirectory)</IntermediateOutputPath>
  </PropertyGroup>
  
  <!-- All projects in the repository -->
  <ItemGroup> 
      <SolutionProjects Include="$(RepositoryRootDirectory)src\*\*\*.csproj" />
      <SolutionProjectsWithoutVSIX Include="@(SolutionProjects)"
                                Exclude="$(VSIXProject)" />
  </ItemGroup>

  <Target Name="BatchSign">
    <MSBuild
      Projects="@(SolutionProjectsWithoutVSIX)"
      Targets="GetSigningInputs">

      <Output
          TaskParameter="TargetOutputs"
          ItemName="FilesToSign" />
    </MSBuild>
    <Message Text="Files to sign ----- @(FilesToSign)" Importance="High"/>
  </Target>

  <Target Name="BatchLocalize" Condition="'$(BuildRTM)' != 'true'">
    <MSBuild
      Projects="$(VsixProject)"
      Targets="GetAssembliesInVsix">

      <Output
          TaskParameter="TargetOutputs"
          ItemName="VsixAssemblies" />
    </MSBuild>
    <ItemGroup>
      <FilesToLocalize Include="@(VsixAssemblies->Distinct())"/>
    </ItemGroup>
    <!-- Message Text="Files to localize : @(FilesToLocalize)" Importance="High"/ -->
  </Target>

  <Target Name="AfterBuild" DependsOnTargets="BatchSign"/>
  <Import Project="$(SolutionPackagesFolder)microbuild.core.0.2.0\build\MicroBuild.Core.targets" />
</Project>